# The DS JSON-RPC server

## 1) Overview

The directory server JSON-RPC server (from now on called server)
publish a number of methods to be used by nodes in order for them to
be a part of an anond overlay network. It provides the central
functionality provided by the *Public Directory Server* (DS) refered
to in [Anonymous overlay network supporting authenticated
routing](Schlegel-Wong-3.pdf).

The following methods are currently made available:

* `publish-node`
* `unpublish-node`
* `still-published-nodes`
* `get-random-nodes`
* `reserve-oa`
* `get-network-topology` (experimental)

The server conforms to the (JSON-RPC 2.0
Specification)[http://www.jsonrpc.org/specification] and uses HTTP
over SSL as its transport mechanism.

All incoming HTTP requests to the server must be signed using a
[keyed-hash message authentication code
(HMAC)](http://en.wikipedia.org/wiki/Hash-based_message_authentication_code).
To bootstrap the HMAC signing scheme each node initially publish its
public signing key with a non-signed call to the `publish-node` method.

The result returned from this call is a unique and `node-id` (and
more) and the node must send it along with each HTTP request its sends
to the server as a `Node-ID` HTTP header. After this call the DS knows
about the assocation between a specific `node-id` and its public
signing key.

From here on the node must sign all HTTP requests it sends to the
server and to do this it calculates a HMAC from the body of the HTTP
request and sends this HMAC along with the HTTP request as a base64
encoded `Content-HMAC` HTTP header. 

There is more to this. Please read on.

## 2) The JSON-RPC methods

In this section each server method's input parameters and the result
it produces are specified using [JSON schemas](http://json-schema.org).

### 2.1) Method: *publish-node*

Params:

```json
{
    "$schema": "http://json-schema.org/draft-03/schema#",
    "name": "publish-node params",
    "type": "object",
    "properties": {
        "public-key": {
            "description": "A base64 encoded public signing key
            as generated by the crypto_sign_keypair function in the
            NaCl library (http://nacl.cr.yp.to/sign.html), i.e. a key
            suitable for a signature scheme based on Curve25519 in
            Edwards form and SHA-512.", 
            "type": "string",
            "media": {
                "binaryEncoding": "base64",
            }
        }
    },
    "required": ["public-key"]
}
```

Result:

```json
{
    "$schema": "http://json-schema.org/draft-03/schema#",
    "name": "publish-node result",
    "type": "object",
    "properties": {
        "ds-id": {
            "description":
                "A `ds-id` in the same number space as the
                `node-ids`. DS picks this `id` in order to identify
                itself when it communicates with nodes using anond's
                encrypted and bit oriented protocol used for node
                tunnel establishment etc. Read more about this bit
                protocol in ds-node-udp-protocol.md.
            "type": "number",
            "minimum": 0,
            "maximum": 2147483647
        },
        "node-id": {
            "description":
                "If a node does not specify 'Content-HMAC' and
                'Node-ID' HTTP headers in the HTTP request the DS will
                allocate a new unique `node-id` which the node should
                use to identify itself. If a node specify these HTTP
                headers the `node-id` will be the same as specified in
                the 'Node-ID' header.",
            "type": "number",
            "minimum": 0,
            "maximum": 2147483647
        },
        "shared-key": {
            "description":
                "A base64 encoded shared stream key as defined in the
                NaCl library (http://nacl.cr.yp.to/stream.html),
                i.e. a key suitable for encryption based on an
                Salsa20/20 encryption scheme. This shared stream key
                is used by the node when it communicates with the DS
                using anond's encrypted bit oriented protocol used for
                node tunnel establishment etc. Read more about this
                bit protocol in ds-node-udp-protocol.md",
            "type": "string",
            "media": {
                "binaryEncoding": "base64",
            }
        },
        "node-ttl": {
            "description":
                "A node must republish itself within this number of
                milli-seconds or else it will be purged from the anond
                overlay network. A node republish itself with a new
                call to the `publish-node` method and is then provided
                with a new shared stream key but it also has the
                opportunity to renegotiate a new public signing key
                with the DS. Note: If a node has forgotten its secret
                signing key (the companion to the public signing key)
                it has to call `publish-node` again without any
                'Content-HMAC' and 'Node-ID' HTTP headers in the HTTP
                request, i.e. and it will get a new `node-id`. The old
                `node-id` will not be given to any other node until a
                server defined grace period has passed (~two weeks).",
            "type": "number",
            "minimum": 0
        }
    }
}

Example:
```
$ curl 
